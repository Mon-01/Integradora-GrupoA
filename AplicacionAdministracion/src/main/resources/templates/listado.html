<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Listado de Nóminas</title>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .btn { padding: 5px 10px; text-decoration: none; color: white; }
    .btn-primary { background: blue; }
    .btn-danger { background: red; }
  </style>
  <!-- Añadir jQuery para AJAX -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div th:replace="~{fragments/navPersonal :: navP}"></div>

<h1>Nóminas</h1>
<a href="/nueva" class="btn btn-primary">Nueva Nómina</a>

<div id="error" style="color: red;"></div>
<!-- Filtros de búsqueda -->
<form id="filtroForm">
  <input type="text" id="nombre" placeholder="Nombre" >
  <input type="text" id="departamento" placeholder="Departamento" >
  <input type="date" id="fecha" placeholder="Fecha de emisión" >
  <button type="submit">Buscar</button>
</form>

<table id="nominasTable">
  <thead>
  <tr>
    <th>ID</th>
    <th>Fecha</th>
    <th>Empleado</th>
    <th>Total</th>
    <th>Acciones</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="nomina : ${nominas}">
    <td th:text="${nomina.id}"></td>
    <td th:text="${nomina.fecha != null} ? ${#temporals.format(nomina.fecha, 'dd/MM/yyyy')} : 'Sin fecha'"></td>
    <td th:text="${nomina.empleado?.nombre}"></td>
    <td th:with="totalValue=${nomina.total != null ? nomina.total : 0}">
      € <span th:text="${#numbers.formatDecimal(totalValue, 1, 2)}">0.00</span>
    </td>
    <td>
      <button th:data-id="${nomina.id}" class="btn btn-danger eliminar-btn">Eliminar</button>
    </td>
  </tr>
  </tbody>
</table>

<script>
  $(document).ready(function() {
    $('.eliminar-btn').click(function() {
      const id = $(this).data('id');
      const row = $(this).closest('tr');

      if(confirm('¿Está seguro de que desea eliminar esta nómina? Esta acción no se puede deshacer.')) {
        $.ajax({
          url: '/api/admin/del/nomina/' + id,
          type: 'DELETE',
          success: function(result) {
            row.fadeOut(400, function() {
              row.remove();
            });
            alert('Nómina eliminada correctamente');
          },
          error: function(xhr) {
            alert('Error al eliminar la nómina: ' + xhr.responseText);
          }
        });
      }
    });
  });

  document.getElementById("filtroForm").addEventListener('submit', async (event) => {
    event.preventDefault();

    const nombre = document.getElementById("nombre").value;
    const fecha = document.getElementById("fecha").value;
    const departamento = document.getElementById("departamento").value;

    const filtroData = {
      nombre: nombre,
      departamento: departamento,
      fecha: fecha

    };

    try {
      const response = await fetch('/api/admin/filtroNominas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filtroData)
      });

      if (response.ok) {
        const nominas = await response.json();
        // Actualizar la tabla con los resultados
        actualizarTabla(nominas);
      } else {
        const error = await response.text();
        document.getElementById('error').innerText = error;
      }
    } catch (err) {
      document.getElementById('error').innerText = "Error inesperado: " + err.message;
    }
  });

  function actualizarTabla(nominas) {
    const tbody = document.querySelector('#nominasTable tbody');
    tbody.innerHTML = ''; // Limpiar tabla

    nominas.forEach(nomina => {
      const row = document.createElement('tr');
      row.innerHTML = `
            <td>${nomina.id}</td>
            <td>${nomina.fecha ? new Date(nomina.fecha).toLocaleDateString() : 'Sin fecha'}</td>
            <td>${nomina.nombre}</td>
            <td>€ ${nomina.total ? nomina.total.toFixed(2) : '0.00'}</td>
            <td>
                <button data-id="${nomina.id}" class="btn btn-danger eliminar-btn">Eliminar</button>
            </td>
        `;
      tbody.appendChild(row);
    });

    // Reasignar eventos a los botones de eliminar
    $('.eliminar-btn').off('click').click(function() {
      // Tu código existente para eliminar
    });
  }
</script>
</body>
</html>
