<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Área Personal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 50px auto 0 auto;
        }
        .bienvenida {
            background: #e0e0e0;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 2rem;
        }
        .bienvenida strong {
            color: #d32f2f;
        }
        a {
            color: #d32f2f;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .boton-registro {
            background-color: #d32f2f;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .boton-registro:hover {
            background-color: #b71c1c;
        }

        /* Estilos del modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: modalopen 0.3s;
        }
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .save-button {
            background-color: #d32f2f;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        .save-button:hover {
            background-color: #b71c1c;
        }

        /* Notificación personalizada */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            color: white;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s;
        }
        .notification-success {
            background-color: #4CAF50;
        }
        .notification-error {
            background-color: #f44336;
        }
        @keyframes fadeIn {
            from {opacity: 0; right: -100px;}
            to {opacity: 1; right: 20px;}
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navPersonal :: navP}"></div>
<div class="container">
    <h1>Área personal</h1>

    <div class="bienvenida">
        <p>Bienvenido <strong th:text="${usuarioEmail}"></strong></p>
        <p>Número de accesos desde tu navegador: <strong th:text="${contadorSesion}"></strong></p>
        <p>Número total de accesos: <strong id="contadorTotal" th:text="${contadorTotal}"></strong></p>
    </div>

    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.
        Vestibulum lectus turpis, laoreet vitae dignissim eu, laoreet nec nisl. Donec dapibus...</p>
</div>

<div th:if="${usuario.empleado == null}" style="text-align: center; margin-top: 20px;">
    <form action="/paso1" method="get">
        <button type="submit" class="boton-registro">Registrar Empleado</button>
    </form>
</div>

<!-- Modal para editar perfil -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Editar Perfil</h2>
        <form id="profileForm">
            <div class="form-group">
                <label for="nombre">Nombre:</label>
                <input type="text" id="nombre" name="nombre" th:value="${usuario.empleado?.nombre}">
            </div>
            <div class="form-group">
                <label for="apellido">Apellido:</label>
                <input type="text" id="apellido" name="apellido" th:value="${usuario.empleado?.apellido}">
            </div>
            <div class="form-group">
                <label for="telefono">Teléfono:</label>
                <input type="text" id="telefono" name="telefono" th:value="${usuario.empleado?.telefono}">
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" th:value="${usuario.email}">
            </div>
            <button type="submit" class="save-button">Guardar Cambios</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos del DOM
        const editProfileBtn = document.getElementById('editProfileBtn');
        const modal = document.getElementById('profileModal');
        const closeBtn = document.querySelector('.close');
        const profileForm = document.getElementById('profileForm');

        // Función para mostrar notificación
        function showNotification(message, isSuccess) {
            const notification = document.createElement('div');
            notification.className = `custom-notification ${isSuccess ? 'notification-success' : 'notification-error'}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Desaparecer después de 3 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        // Manejar el envío del formulario
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Mostrar mensaje de carga
            showNotification("Actualizando perfil...", true);

            const formData = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value
            };

            try {
                const response = await fetch('/usuario/actualizar', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Error al actualizar el perfil');
                }

                showNotification(data.message, true);

                // Cerrar modal y recargar después de 1 segundo
                setTimeout(() => {
                    modal.style.display = 'none';
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, false);
            }
        });

        // Event listeners para abrir/cerrar modal
        if (editProfileBtn) {
            editProfileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                modal.style.display = 'block';
            });
        }

        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>
